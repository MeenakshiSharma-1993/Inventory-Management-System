<?php
session_start();
include './public/Database/connection.php';

// Access control
$user = $_SESSION['username'];
if (!isset($user)) {
    header("location: login.php");
    exit();
}

// DELETE user
include './public/Database/delete.php';

// UPDATE user
include './public/Database/update.php'; // make sure this handles batch updates

// Fetch orders with product and supplier info
$sql = "
  SELECT o.id AS order_id, s.supplier_name, o.product, p.product_name,
         o.quantity_ordered, o.quantity_received, o.quantity_remaining,
         o.status, o.created_by, o.created_at, o.updated_at, o.batch 
  FROM order_product AS o 
  JOIN products AS p ON FIND_IN_SET(p.id, o.product)
  JOIN supplier AS s ON s.id = o.supplier
  ORDER BY o.batch, o.created_at DESC;
";
$result = mysqli_query($conn, $sql);

// Group orders by batch and order ID
$batches = [];
while ($r = mysqli_fetch_assoc($result)) {
    $batch = $r['batch'];
    $oid = $r['order_id'];
    if (!isset($batches[$batch][$oid])) {
        $batches[$batch][$oid] = [
            'order_id'           => $oid,
            'supplierName'       => $r['supplier_name'],
            'product_ids'        => $r['product'],
            'product_names'      => [],
            'quantity_ordered'   => $r['quantity_ordered'],
            'quantity_received'  => $r['quantity_received'],
            'quantity_remaining' => $r['quantity_remaining'],
            'status'             => $r['status'],
            'created_by'         => $r['created_by'],
            'created_at'         => $r['created_at'],
            'updated_at'         => $r['updated_at'],
        ];
    }
    $batches[$batch][$oid]['product_names'][] = $r['product_name'];
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>View Orders</title>
    <link rel="stylesheet" href="public/css/style.css">
    <script src="https://kit.fontawesome.com/dfec668964.js" crossorigin="anonymous"></script>
    <style>
        .modal-edit-table {
            width: 100%;
            border-collapse: collapse;
        }
        .modal-edit-table th, .modal-edit-table td {
            padding: 8px;
            border: 1px solid #ccc;
        }
        .modal-edit-table input {
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
        }
        #modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            display: none;
            z-index: 9999;
        }
        #modal .add-user {
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
<div class="container">
    <?php include 'partial/app-sidebar.php'; ?>
    <div class="main">
        <?php include 'partial/app-topnav.php'; ?>

        <div class="content-container">
            <!-- Modal -->
            <div id="modal">
                <div class="add-user" style="background:#fff; padding:20px; border:1px solid #000; min-width:600px;">
                    <h3>Edit Orders in Batch</h3>
                    <form method="POST" action="public/Database/update.php">
                        <input type="hidden" name="batch_id" id="batchId">
                        <table class="modal-edit-table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Supplier</th>
                                    <th>Product IDs</th>
                                    <th>Qty Ordered</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="modal-table-body">
                                <!-- JavaScript inserts rows here -->
                            </tbody>
                        </table>
                        <div style="margin-top:15px;">
                            <input class="formBtn" name="update_batch" type="submit" value="Update All">
                            <input class="formBtn" id="cancelBtn" type="button" value="Cancel">
                        </div>
                    </form>
                </div>
            </div>

            <!-- Orders List -->
            <div class="list-order">
                <div class="add-user">
                    <h3><i class="fas fa-list"></i> List of Purchase Orders</h3>
                </div>
                <?php if (!empty($batches)): ?>
                    <?php foreach ($batches as $batchKey => $orders): ?>
                        <h4 style="margin-top:20px;">Batch#: <?= htmlspecialchars($batchKey) ?></h4>
                        <table id="order-view" cellspacing="0" cellpadding="0">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Supplier</th>
                                    <th>Product(s)</th>
                                    <th>Qty Ordered</th>
                                    <th>Qty Received</th>
                                    <th>Qty Remaining</th>
                                    <th>Status</th>
                                    <th>Created At</th>
                                    <th>Updated At</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach ($orders as $o): ?>
                                    <tr>
                                        <td><?= $o['order_id'] ?></td>
                                        <td><?= htmlspecialchars($o['supplierName']) ?></td>
                                        <td><?= htmlspecialchars(implode(', ', $o['product_names'])) ?></td>
                                        <td><?= $o['quantity_ordered'] ?></td>
                                        <td><?= $o['quantity_received'] ?></td>
                                        <td><?= $o['quantity_remaining'] ?></td>
                                        <td><span class="order-status-<?= htmlspecialchars($o['status']) ?>"><?= htmlspecialchars($o['status']) ?></span></td>
                                        <td><?= date('m, d, y @ h:i:s A', strtotime($o['created_at'])) ?></td>
                                        <td><?= date('m, d, y @ h:i:s A', strtotime($o['updated_at'])) ?></td>
                                        <td>
                                            <a href="#" class="edit-btn" data-batch="<?= htmlspecialchars($batchKey) ?>"><i class="fa fa-pencil"></i>Edit</a>
                                            <a href="?delete_order=<?= $o['order_id'] ?>" class="delete-btn"
                                               onclick="return confirm('Delete Order ID <?= $o['order_id'] ?>?');"><i class="fa fa-trash"></i>Delete</a>
                                        </td>
                                    </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    <?php endforeach; ?>
                <?php else: ?>
                    <p>No orders found.</p>
                <?php endif; ?>
            </div>
        </div>
    </div>
</div>

<script>
    const batches = <?= json_encode($batches) ?>;

    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', e => {
            e.preventDefault();
            const batchKey = btn.dataset.batch;
            const orders = batches[batchKey];
            const tableBody = document.getElementById('modal-table-body');
            document.getElementById('batchId').value = batchKey;
            tableBody.innerHTML = '';

            for (const oid in orders) {
                const order = orders[oid];
                tableBody.innerHTML += `
                    <tr>
                        <td>
                            ${order.order_id}
                            <input type="hidden" name="order_ids[]" value="${order.order_id}">
                        </td>
                        <td><input name="suppliers[]" value="${order.supplierName}" required></td>
                        <td><input name="products[]" value="${order.product_ids}" required></td>
                        <td><input name="quantity_ordered[]" type="number" value="${order.quantity_ordered}" required></td>
                        <td><input name="statuses[]" value="${order.status}" required></td>
                    </tr>
                `;
            }

            document.getElementById('modal').style.display = 'flex';
        });
    });

    document.getElementById('cancelBtn').addEventListener('click', () => {
        document.getElementById('modal').style.display = 'none';
    });

    document.getElementById('modal').addEventListener('click', e => {
        if (e.target === document.getElementById('modal')) {
            document.getElementById('modal').style.display = 'none';
        }
    });
</script>
</body>
</html>
